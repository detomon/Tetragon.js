<!DOCTYPE html>
<html>
<head>
	<title>Contraints</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width" />
	<link href="css/main.css" rel="stylesheet" />
</head>
<body>

<div class="canvas-wrapper">
	<canvas width="800" height="600" id="canvas"></canvas>
</div>

<script src="../tetragon.js"></script>
<script>

var system = new Tetragon.EntitySystem();

system.createComponent({
	name: 'draw',
	draw: function (ctx, info) {
		var pos = this.entity.componentData('pointMass');
		var diff = pos.point.p.sub(pos.point.pp);

		pos = pos.point.p.add(diff.mult(info.frameDelta));

		ctx.fillRect(pos.x, pos.y, 20, 20);
	}
});

system.createComponent({
	name: 'pointMass',
	construct: function (point, mass) {
		this.point = new Tetragon.PointMass(point, mass);
	},
	tick: function (dt) {
		this.point.inertia(dt);
		//this.entity.componentData('position').pos = this.point.p.copy();
	}
});

system.createComponent({
	name: 'constraint',
	construct: function (point1, point2, restDist, stiffness) {
		this.constraint = new Tetragon.Constraint(point1, point2, restDist, stiffness);
	},
	tick: function (dt) {
		this.constraint.solve();
	}
});

system.createComponent({
	name: 'gravity',
	tick: function (dt) {
		var data = this.entity.componentData('pointMass');
		data.point.applyForce(new Tetragon.Vector(0, 1000));
	}
});

var point1 = system.createEntity();
var point2 = system.createEntity();
var constraint = system.createEntity();

var p1 = point1.addComponent('pointMass', new Tetragon.Vector(-200, -200));
var p2 = point2.addComponent('pointMass', new Tetragon.Vector(0, -200));

point1.addComponent('draw');
point2.addComponent('draw');

point1.addComponent('gravity');

constraint.addComponent('constraint', p1.point, p2.point, 100, 0.1);


var canvas = document.getElementById('canvas');

var controller = new Tetragon.Canvas({
	element: canvas,
	tick: function (dt, info) {
		system.iterate('gravity', 'tick', dt);
		system.iterate('pointMass', 'tick', dt);
		system.iterate('constraint', 'tick', dt);
	},
	draw: function (ctx, info) {
		system.iterate('draw', 'draw', ctx, info);
	}
});

controller.startAnimating();

</script>

</body>
</html>
