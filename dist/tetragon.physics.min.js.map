{"version":3,"sources":["tetragon.physics.js"],"names":["w","Tetragon","version","window","T","PointMass","position","mass","this","p","copy","pp","a","Vector","invMass","Number","MAX_VALUE","damping","pinned","proto","prototype","inertia","dt","dtf","v","sub","mult","n","add","applyForce","force","pin","Constraint","p1","p2","restDist","stiffness","undefined","length","solve","d","l","r","f1","s1","s2","QuadTree","rect","quads","quadFlags","items","Quad","parent","idx","Item","item","quad","remove","indexOf","splice","move","addItem","index","center","push","contains","pos","x","size","y","quadRect","forEachItemInRect","callback","i","intersects","subquad"],"mappings":"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","file":"tetragon.physics.min.js","sourcesContent":["(function (w) {\n'use strict';\n\nw.Tetragon = w.Tetragon || {\n\tversion: '0.1.5',\n};\n\n}(window));\n\n/**\n * @depend tetragon.js\n */\n\n(function (T) {\n'use strict';\n\n/**\n * Defines a point mass\n *\n * The point is initialized with an initial `position` and a `mass`\n * More mass means more inertness\n */\nvar PointMass = T.PointMass = function (position, mass) {\n\t// current position\n\tthis.p = position.copy();\n\n\t// previous position\n\tthis.pp = position.copy();\n\n\t// acceleration for current frame\n\tthis.a = new T.Vector(); // null vector\n\n\t// mass; set to 1.0 if not defined\n\tthis.mass = mass ||Â 1.0;\n\n\t// inverse mass\n\tif (this.mass == 0.0) {\n\t\tthis.invMass = Number.MAX_VALUE;\n\t}\n\telse if (this.mass == Number.MAX_VALUE) {\n\t\tthis.invMass = 0.0;\n\t}\n\telse {\n\t\tthis.invMass = 1.0 / this.mass;\n\t}\n\n\t// set default damping value\n\tthis.damping = 0.997;\n\n\t// `true` if pinned to current position\n\tthis.pinned = false;\n};\n\nvar proto = PointMass.prototype;\n\n/**\n * Move point to next position\n */\nproto.inertia = function(dt) {\n\t// time depending factor used for acceleration\n\t// dtf = 0.5 * dt^2\n\tvar dtf = 0.5 * dt * dt;\n\n\t// get velocity vector and add damping\n\t// v = (p - pp) * damping\n\tvar v = this.p.sub(this.pp).mult(this.damping);\n\n\t// this is more accurate, but also slower\n\t// v = (p - pp) * damping ^ dt\n\t//var v = this.p.sub(this.pp).mult(Math.pow(this.damping, dt));\n\n\t// calculate next position by adding velocity\n\t// and acceleration to current position\n\t// n = p + v + a * dtf\n\tvar n = this.p.add(v.add(this.a.mult(dtf)));\n\n\t// set previous position to current position\n\tthis.pp = this.p.copy();\n\n\t// set current position to next position\n\tthis.p = n;\n\n\t// clear acceleration for current step\n\tthis.a = new T.Vector();\n};\n\n/**\n * Add force vector\n */\nproto.applyForce = function(force) {\n\t// add force multiplied with inverse of mass\n\t// a += force * (1.0 / mass)\n\tthis.a = this.a.add(force.mult(this.invMass));\n};\n\n/**\n * Pin point to its current position\n */\nproto.pin = function() {\n\tthis.pp     = this.p.copy();\n\tthis.pinned = true;\n};\n\n}(Tetragon));\n\n/**\n * @depend tetragon.js\n */\n\n(function (T) {\n'use strict';\n\n/**\n * Defines a constraint between two point masses\n *\n * Keeps the points `p1` and `p1` at a given resting distance `restDist`\n * A `stiffness` value of 1.0 sets the maximum responsiveness\n * Values below 1.0 and above 0.0 make the constraint more \"rubbery\"\n *\n * If `restDist` is omitted, it is set to the initial distance\n *   between `p1` and `p2`\n * If `stiffness` is omitted, it is set to its maximum value 1.0\n */\nvar Constraint = T.Constraint = function (p1, p2, restDist, stiffness) {\n\t// set current distance as resting distance if not defined\n\tif (restDist === undefined) {\n\t\trestDist = p2.p.sub(p1.p).length;\n\t}\n\n\t// set default stiffness to maximum if not defined\n\tif (stiffness === undefined) {\n\t\tstiffness = 1.0;\n\t}\n\n\t// set controlling points\n\tthis.p1 = p1;\n\tthis.p2 = p2;\n\n\t// set resting distance\n\tthis.restDist = restDist;\n\n\t// set stiffness\n\tthis.stiffness = stiffness;\n}\n\nvar proto = Constraint.prototype;\n\n/**\n * Solve step\n */\nproto.solve = function() {\n\tvar p1 = this.p1;\n\tvar p2 = this.p2;\n\n\t// current distance vector between points\n\t// d = p1 - p2\n\tvar d = p1.p.sub(p2.p);\n\n\t// scalar distance between points\n\t// l = |d|\n\tvar l = d.length;\n\n\tvar r = 0.0;\n\n\t// proportion between current distance and resting distance\n\tif (l != 0.0) {\n\t\tr = (this.restDist - l) / l;\n\t}\n\n\t// distance vector differing from resting distance\n\t// d *= r\n\td = d.mult(r);\n\n\t// mass influence of `p1` as fraction between 0.0 and 1.0\n\t// `0.5` would mean that `p1` and `p2` have the same mass\n\tvar f1 = 1.0 - p1.mass / (p1.mass + p2.mass);\n\n\t// influences of `p1` and `p2`\n\tvar s1 = f1 * this.stiffness;\n\tvar s2 = this.stiffness - s1;\n\n\tif (!p1.pinned) {\n\t\t// p1 += d * s1\n\t\tp1.p = p1.p.add(d.mult(s1));\n\t}\n\n\tif (!p2.pinned) {\n\t\t// p2 -= d * s2\n\t\tp2.p = p2.p.sub(d.mult(s2));\n\t}\n};\n\n}(Tetragon));\n\n/**\n * @depend tetragon.js\n */\n\n(function (T) {\n'use strict';\n\nvar QuadTree = T.QuadTree = function (rect) {\n\tthis.quads = [];\n\tthis.quadFlags = 0;\n\tthis.items = [];\n\tthis.rect = rect.copy();\n};\n\nvar Quad = QuadTree.Quad = function (parent, idx, rect) {\n\tthis.parent = parent;\n\tthis.idx = idx;\n\tthis.quads = [];\n\tthis.quadFlags = 0;\n\tthis.items = [];\n\tthis.rect = rect.copy();\n};\n\nvar Item = QuadTree.Item = function (item, rect) {\n\tthis.quad = null;\n\tthis.item = item;\n\tthis.rect = rect.copy();\n};\n\nItem.prototype.remove = function () {\n\tvar idx;\n\tvar parent;\n\tvar quad = this.quad;\n\n\tidx = quad.items.indexOf(this);\n\tquad.items.splice(idx, 1);\n\n\tfor (; quad; quad = parent) {\n\t\tparent = quad.parent;\n\n\t\tif (parent && !quad.items.length && !quad.quadFlags) {\n\t\t\tdelete parent.quads[quad.idx];\n\t\t\tparent.quadFlags &= ~(1 << quad.idx);\n\t\t}\n\t}\n};\n\nItem.prototype.move = function (rect) {\n\tthrow 'unimplemented method move';\n};\n\nQuadTree.prototype.addItem = function (item, rect) {\n\tvar index;\n\tvar quad = this;\n\tvar item = new Item(item, rect);\n\tvar center;\n\n\twhile (quad) {\n\t\tcenter = quad.rect.center;\n\n\t\tif (!quad.items.length) {\n\t\t\titem.quad = quad;\n\t\t\tquad.items.push(item);\n\t\t\tbreak;\n\t\t}\n\t\telse if (quad.rect.contains(rect)) {\n\t\t\tif (rect.pos.x + rect.size.x < center.x) {\n\t\t\t\tindex = 0;\n\t\t\t}\n\t\t\telse if (rect.pos.x >= center.x) {\n\t\t\t\tindex = 2;\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.quad = quad;\n\t\t\t\tquad.items.push(item);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tif (rect.pos.y + rect.size.y < center.y) {\n\t\t\t\tindex += 0;\n\t\t\t}\n\t\t\telse if (rect.pos.y >= center.y) {\n\t\t\t\tindex += 1;\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.quad = quad;\n\t\t\t\tquad.items.push(item);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\titem.quad = quad;\n\t\t\tquad.items.push(item);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!quad.quads[index]) {\n\t\t\tvar quadRect = quad.rect.copy();\n\n\t\t\tquadRect.size.x *= 0.5;\n\t\t\tquadRect.size.y *= 0.5;\n\n\t\t\tswitch (index) {\n\t\t\t\tcase 0: {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 1: {\n\t\t\t\t\tquadRect.pos.y += quadRect.size.y;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 2: {\n\t\t\t\t\tquadRect.pos.x += quadRect.size.x;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 3: {\n\t\t\t\t\tquadRect.pos.x += quadRect.size.x;\n\t\t\t\t\tquadRect.pos.y += quadRect.size.y;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tquad.quads[index] = new Quad(quad, index, quadRect);\n\t\t\tquad.quadFlags |= (1 << index);\n\t\t}\n\n\t\tquad = quad.quads[index];\n\t}\n\n\treturn item;\n};\n\nQuadTree.prototype.forEachItemInRect = function (callback, rect, quad) {\n\tvar i;\n\n\tquad = quad || this;\n\n\tfor (i = 0; i < quad.items.length; i ++) {\n\t\tvar item = quad.items[i];\n\n\t\tif (rect.intersects(item.rect)) {\n\t\t\tcallback(item.item, item);\n\t\t}\n\t}\n\n\tfor (i = 0; i < quad.quads.length; i ++) {\n\t\tvar subquad = quad.quads[i];\n\n\t\tif (subquad && rect.intersects(subquad.rect)) {\n\t\t\tthis.forEachItemInRect(callback, rect, subquad);\n\t\t}\n\t}\n};\n\n}(Tetragon));\n"]}